<html>
<body>
  <script src="./Data/js/third_party/gl-matrix.js/gl-matrix-min.js"></script>
<script src="./Data/js/third_party/litegl.js/litegl.min.js"></script>
  <script type='text/javascript'>
window.artoolkitX_wasm_url = '../SDK/lib/artoolkitx.wasm';
  </script>

  <script type="module" src="../SDK/lib/artoolkitX.api.js"></script>
<video id="v" src="Data/output_4.mp4" width="320" height="240" loop="" controls="" autoplay></video>
<script type="module">
    import ARController from '../SDK/lib/artoolkitX.api.js';
    let ar1, interval;

    const cameraParam = './Data/camera_para.dat';

    const config = {
        cameraParam: cameraParam,
        width: 320,
        height: 240
    };

    var trackable = {
        trackableType: "single_barcode",
        barcodeId: 1
    }
    
    window.addEventListener('artoolkitX-loaded', () => {
      //set some global properties
      var cam_pos = [0,10,10];
      var cam_center = [0,0,0];
      //create basic matrices for cameras and transformation
      var proj = mat4.create();
      var view = mat4.create();
      var model = mat4.create();
      var mvp = mat4.create();
      var temp = mat4.create();
      
      var container = document.body;
      var gl = GL.create({width:320, height:240});
      container.appendChild(gl.canvas);    
    
    var arController = new ARController(v, cameraParam);
    arController.addEventListener('getMarker', (trackableInfo) => {
        //console.log("TrackableID: " + trackableInfo.data.trackableId);
        const transformation = trackableInfo.data.transformation;
        const markerVisible = trackableInfo.visible;
        //console.log(model);
        //model = transformation;
    });
    var video = document.getElementById('v');
    try {
        arController.start().then( () => {
            console.log("start done");
            var trackableId = arController.addTrackable(trackable);
            //basic phong shader
            var shader = new Shader('\
              precision highp float;\
              attribute vec3 a_vertex;\
              attribute vec3 a_normal;\
              varying vec3 v_normal;\
              uniform mat4 u_mvp;\
              uniform mat4 u_model;\
              void main() {\
                v_normal = (u_model * vec4(a_normal,0.0)).xyz;\
                gl_Position = u_mvp * vec4(a_vertex,1.0);\
              }\
              ', '\
              precision highp float;\
              varying vec3 v_normal;\
              uniform vec3 u_lightvector;\
              uniform vec4 u_camera_position;\
              uniform vec4 u_color;\
              void main() {\
                vec3 N = normalize(v_normal);\
                //fake half light\n\
                float NdotL = dot(u_lightvector,N) * 0.5 + 0.5;\
                NdotL *= NdotL;\
                gl_FragColor = u_color * max(0.0, NdotL);\
              }\
            ');
            
            interval = setInterval(function() {
                arController.process(video);
                //load a mesh (cube)
                var mesh = GL.Mesh.cube({size:5});
                //set the camera position
                mat4.perspective(proj, 45 * DEG2RAD, gl.canvas.width / gl.canvas.height, 0.1, 1000);
                //rendering loop
                //generic gl flags and settings
                gl.clearColor(0.1,0.1,0.1,1);
                gl.enable( gl.DEPTH_TEST );
                
                //const camMatrix = arController.getCameraMatrix(0.1, 1000);
              
                gl.animate();
                gl.ondraw = function()
                {
                	gl.clear( gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT );
                	mat4.lookAt(view, cam_pos, cam_center, [0,1,0]);
                	//create modelview and projection matrices
                	mat4.multiply(temp,view,model);
                	mat4.multiply(mvp,proj,temp);
                  //render mesh using the shader
                	if(mesh)
                  {
                		shader.uniforms({ //set uniforms
                			u_color: [1,1,1,1],
                			u_lightvector: vec3.normalize(vec3.create(),[1,1,1]),
                			u_camera_position: cam_pos,
                			u_model: model,
                			u_mvp: mvp
                		}).draw(mesh); //draw mesh
                    };
                }
                gl.onupdate = function (){              
                }
              }, 13);
              ar1 = arController;
          })
        }  
        catch (e) {
            console.log(e); 
  }
});
    </script>
  </body>
</html>